<form
  id="contactForm"
  class="w-full max-w-2xl mx-auto mt-20 rounded-2xl border border-white/10 bg-zinc-900/80
  backdrop-blur-md shadow-[0_10px_30px_-10px_rgba(0,0,0,0.6)] p-6 sm:p-8 space-y-6 lg:mx-0 lg:translate-x-22"
>
  <!-- Header -->
  <div class="space-y-1">
    <h3 class="text-xl text-white/90">Send a message</h3>
    <p class="text-sm text-white/60">
      I’ll get back to you as soon as possible.
    </p>
  </div>
  <!-- Name -->
  <label class="block">
    <span class="mb-2 block text-sm font-medium text-white/80">Name</span>
    <input
      name="from_name"
      type="text"
      required
      autocomplete="name"
      class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 text-white
      placeholder-white/30 outline-none transition focus:border-lime-300/60 focus:ring-1 focus:ring-lime-300/40"
      placeholder="Your name"
    />
  </label>

  <!-- Email -->
  <label class="block">
    <span class="mb-2 block text-sm font-medium text-white/80">Email</span>
    <input
      name="user_email"
      type="email"
      required
      autocomplete="email"
      inputmode="email"
      class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 text-white
      placeholder-white/30
             outline-none transition
             focus:border-lime-300/60 focus:ring-1 focus:ring-lime-300/40"
      placeholder="you@email.com"
    />
  </label>

  <!-- Subject -->
  <label class="block">
    <span class="mb-2 block text-sm font-medium text-white/80">Subject</span>
    <input
      name="subject"
      type="text"
      required
      class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 text-white
      placeholder-white/30
             outline-none transition
             focus:border-lime-300/60 focus:ring-1 focus:ring-lime-300/40"
      placeholder="What’s this about?"
    />
  </label>

  <!-- Message -->
  <label class="block">
    <span class="mb-2 block text-sm font-medium text-white/80">Message</span>
    <textarea
      name="message"
      required
      rows="6"
      class="w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 text-white
      placeholder-white/30
             outline-none transition resize-y
             focus:border-lime-300/60 focus:ring-1 focus:ring-lime-300/40"
      placeholder="Tell me about your project..."></textarea>
  </label>

  <!-- Submit -->
  <div class="flex items-center justify-between gap-4">
    <p class="text-xs text-white/50">
      By sending, you agree to be contacted about this inquiry.
    </p>

    <button
      id="contactBtn"
      type="submit"
      class="inline-flex items-center gap-2 rounded-xl bg-lime-300 text-[#090b11] px-5 py-3
      font-semibold
             shadow-[0_8px_20px_-8px_rgba(190,242,100,0.6)]
             transition active:scale-[0.98] hover:brightness-95 focus-visible:outline-none
             focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-lime-300
             focus-visible:ring-offset-[#090b11]"
      data-loading="false"
    >
      <span class="cursor-pointer [data-loading=true]:hidden">SEND</span>
    </button>
  </div>
</form>

<script>
  import { getEmailTemplate } from "../utils/emailTemplate"

  const form = document.getElementById("contactForm") as HTMLFormElement
  const btn = document.getElementById("contactBtn")

  if (form && btn) {
    const setLoading = (on: boolean) => {
      btn.toggleAttribute("disabled", on)
      btn.setAttribute("data-loading", on ? "true" : "false")
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      setLoading(true)
      try {
        const formData = new FormData(form)

        const message = String(formData.get("message") ?? "")
        const senderEmail = String(formData.get("user_email") ?? "")
        const subject = String(formData.get("subject") ?? "")

        const htmlTemplate = getEmailTemplate(senderEmail, subject, message)

        const payload = {
          to: "wdiazdev@gmail.com",
          from: "portfolio@wdiazdev.com",
          subject: String(formData.get("subject") ?? ""),
          html: htmlTemplate,
          text: String(formData.get("message") ?? ""),
          replyTo: String(formData.get("user_email") ?? ""),
        }

        const res = await fetch("/api/sendEmail.json", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })

        const out = await res.json()
        if (!res.ok) throw new Error(out?.error || "Failed to send")

        alert("Message sent! I’ll get back to you soon.")
        form.reset()
      } catch (error) {
        console.error("Error: ", error)
        alert("Unable to send message. Please try again.")
      } finally {
        setLoading(false)
      }
    })
  } else {
    console.warn("contactForm or contactBtn not found")
  }
</script>
